service: gcdr-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'sa-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 256
  timeout: 29

  environment:
    STAGE: ${self:provider.stage}
    REGION: ${self:provider.region}
    CUSTOMERS_TABLE: ${self:custom.customersTable}
    PARTNERS_TABLE: ${self:custom.partnersTable}
    ROLES_TABLE: ${self:custom.rolesTable}
    POLICIES_TABLE: ${self:custom.policiesTable}
    ROLE_ASSIGNMENTS_TABLE: ${self:custom.roleAssignmentsTable}
    ASSETS_TABLE: ${self:custom.assetsTable}
    DEVICES_TABLE: ${self:custom.devicesTable}
    RULES_TABLE: ${self:custom.rulesTable}
    INTEGRATIONS_TABLE: ${self:custom.integrationsTable}
    SUBSCRIPTIONS_TABLE: ${self:custom.subscriptionsTable}
    CENTRALS_TABLE: ${self:custom.centralsTable}
    THEMES_TABLE: ${self:custom.themesTable}
    USERS_TABLE: ${self:custom.usersTable}
    EVENT_BUS_NAME: ${self:custom.eventBusName}
    LOG_LEVEL: ${self:custom.logLevel.${self:provider.stage}, 'info'}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt CustomersTable.Arn
            - !Join ['/', [!GetAtt CustomersTable.Arn, 'index', '*']]
            - !GetAtt PartnersTable.Arn
            - !Join ['/', [!GetAtt PartnersTable.Arn, 'index', '*']]
            - !GetAtt RolesTable.Arn
            - !Join ['/', [!GetAtt RolesTable.Arn, 'index', '*']]
            - !GetAtt PoliciesTable.Arn
            - !Join ['/', [!GetAtt PoliciesTable.Arn, 'index', '*']]
            - !GetAtt RoleAssignmentsTable.Arn
            - !Join ['/', [!GetAtt RoleAssignmentsTable.Arn, 'index', '*']]
            - !GetAtt AssetsTable.Arn
            - !Join ['/', [!GetAtt AssetsTable.Arn, 'index', '*']]
            - !GetAtt DevicesTable.Arn
            - !Join ['/', [!GetAtt DevicesTable.Arn, 'index', '*']]
            - !GetAtt RulesTable.Arn
            - !Join ['/', [!GetAtt RulesTable.Arn, 'index', '*']]
            - !GetAtt IntegrationsTable.Arn
            - !Join ['/', [!GetAtt IntegrationsTable.Arn, 'index', '*']]
            - !GetAtt SubscriptionsTable.Arn
            - !Join ['/', [!GetAtt SubscriptionsTable.Arn, 'index', '*']]
            - !GetAtt CentralsTable.Arn
            - !Join ['/', [!GetAtt CentralsTable.Arn, 'index', '*']]
            - !GetAtt ThemesTable.Arn
            - !Join ['/', [!GetAtt ThemesTable.Arn, 'index', '*']]
            - !GetAtt UsersTable.Arn
            - !Join ['/', [!GetAtt UsersTable.Arn, 'index', '*']]
        - Effect: Allow
          Action:
            - events:PutEvents
          Resource:
            - !GetAtt GcdrEventBus.Arn

custom:
  customersTable: gcdr-customers-${self:provider.stage}
  partnersTable: gcdr-partners-${self:provider.stage}
  rolesTable: gcdr-roles-${self:provider.stage}
  policiesTable: gcdr-policies-${self:provider.stage}
  roleAssignmentsTable: gcdr-role-assignments-${self:provider.stage}
  assetsTable: gcdr-assets-${self:provider.stage}
  devicesTable: gcdr-devices-${self:provider.stage}
  rulesTable: gcdr-rules-${self:provider.stage}
  integrationsTable: gcdr-integrations-${self:provider.stage}
  subscriptionsTable: gcdr-subscriptions-${self:provider.stage}
  centralsTable: gcdr-centrals-${self:provider.stage}
  themesTable: gcdr-themes-${self:provider.stage}
  usersTable: gcdr-users-${self:provider.stage}
  eventBusName: gcdr-events-${self:provider.stage}

  logLevel:
    dev: debug
    staging: info
    prod: warn

  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    exclude:
      - '@aws-sdk/*'
    target: node20
    platform: node
    concurrency: 10

plugins:
  - serverless-esbuild
  - serverless-offline

functions:
  # Health Check
  health:
    handler: src/handlers/health.handler
    events:
      - http:
          path: /health
          method: get
          cors: true

  # Customer APIs
  createCustomer:
    handler: src/handlers/customers/create.handler
    events:
      - http:
          path: /customers
          method: post
          cors: true

  getCustomer:
    handler: src/handlers/customers/get.handler
    events:
      - http:
          path: /customers/{id}
          method: get
          cors: true

  updateCustomer:
    handler: src/handlers/customers/update.handler
    events:
      - http:
          path: /customers/{id}
          method: put
          cors: true

  deleteCustomer:
    handler: src/handlers/customers/delete.handler
    events:
      - http:
          path: /customers/{id}
          method: delete
          cors: true

  listCustomers:
    handler: src/handlers/customers/list.handler
    events:
      - http:
          path: /customers
          method: get
          cors: true

  getCustomerChildren:
    handler: src/handlers/customers/getChildren.handler
    events:
      - http:
          path: /customers/{id}/children
          method: get
          cors: true

  getCustomerDescendants:
    handler: src/handlers/customers/getDescendants.handler
    events:
      - http:
          path: /customers/{id}/descendants
          method: get
          cors: true

  getCustomerTree:
    handler: src/handlers/customers/getTree.handler
    events:
      - http:
          path: /customers/{id}/tree
          method: get
          cors: true

  moveCustomer:
    handler: src/handlers/customers/move.handler
    events:
      - http:
          path: /customers/{id}/move
          method: post
          cors: true

  # Partner APIs
  registerPartner:
    handler: src/handlers/partners/register.handler
    events:
      - http:
          path: /partners
          method: post
          cors: true

  getPartner:
    handler: src/handlers/partners/get.handler
    events:
      - http:
          path: /partners/{id}
          method: get
          cors: true

  listPartners:
    handler: src/handlers/partners/list.handler
    events:
      - http:
          path: /partners
          method: get
          cors: true

  approvePartner:
    handler: src/handlers/partners/approve.handler
    events:
      - http:
          path: /partners/{id}/approve
          method: post
          cors: true

  rejectPartner:
    handler: src/handlers/partners/reject.handler
    events:
      - http:
          path: /partners/{id}/reject
          method: post
          cors: true

  updatePartner:
    handler: src/handlers/partners/update.handler
    events:
      - http:
          path: /partners/{id}
          method: put
          cors: true

  suspendPartner:
    handler: src/handlers/partners/suspend.handler
    events:
      - http:
          path: /partners/{id}/suspend
          method: post
          cors: true

  activatePartner:
    handler: src/handlers/partners/activate.handler
    events:
      - http:
          path: /partners/{id}/activate
          method: post
          cors: true

  createPartnerApiKey:
    handler: src/handlers/partners/createApiKey.handler
    events:
      - http:
          path: /partners/{id}/api-keys
          method: post
          cors: true

  listPartnerApiKeys:
    handler: src/handlers/partners/listApiKeys.handler
    events:
      - http:
          path: /partners/{id}/api-keys
          method: get
          cors: true

  revokePartnerApiKey:
    handler: src/handlers/partners/revokeApiKey.handler
    events:
      - http:
          path: /partners/{id}/api-keys/{keyId}
          method: delete
          cors: true

  rotatePartnerApiKey:
    handler: src/handlers/partners/rotateApiKey.handler
    events:
      - http:
          path: /partners/{id}/api-keys/{keyId}/rotate
          method: post
          cors: true

  # OAuth Client endpoints
  createPartnerOAuthClient:
    handler: src/handlers/partners/createOAuthClient.handler
    events:
      - http:
          path: /partners/{id}/oauth-clients
          method: post
          cors: true

  listPartnerOAuthClients:
    handler: src/handlers/partners/listOAuthClients.handler
    events:
      - http:
          path: /partners/{id}/oauth-clients
          method: get
          cors: true

  revokePartnerOAuthClient:
    handler: src/handlers/partners/revokeOAuthClient.handler
    events:
      - http:
          path: /partners/{id}/oauth-clients/{clientId}
          method: delete
          cors: true

  # OAuth2 Token endpoint
  oauthToken:
    handler: src/handlers/partners/token.handler
    events:
      - http:
          path: /oauth/token
          method: post
          cors: true

  # Webhook endpoints
  createPartnerWebhook:
    handler: src/handlers/partners/createWebhook.handler
    events:
      - http:
          path: /partners/{id}/webhooks
          method: post
          cors: true

  listPartnerWebhooks:
    handler: src/handlers/partners/listWebhooks.handler
    events:
      - http:
          path: /partners/{id}/webhooks
          method: get
          cors: true

  updatePartnerWebhook:
    handler: src/handlers/partners/updateWebhook.handler
    events:
      - http:
          path: /partners/{id}/webhooks/{webhookId}
          method: put
          cors: true

  deletePartnerWebhook:
    handler: src/handlers/partners/deleteWebhook.handler
    events:
      - http:
          path: /partners/{id}/webhooks/{webhookId}
          method: delete
          cors: true

  # Authorization APIs
  checkPermission:
    handler: src/handlers/authorization/check.handler
    events:
      - http:
          path: /authorization/check
          method: post
          cors: true

  evaluateBatch:
    handler: src/handlers/authorization/evaluateBatch.handler
    events:
      - http:
          path: /authorization/check/batch
          method: post
          cors: true

  getEffectivePermissions:
    handler: src/handlers/authorization/getEffectivePermissions.handler
    events:
      - http:
          path: /authorization/users/{userId}/permissions
          method: get
          cors: true

  assignRole:
    handler: src/handlers/authorization/assignRole.handler
    events:
      - http:
          path: /authorization/assignments
          method: post
          cors: true

  revokeAssignment:
    handler: src/handlers/authorization/revokeAssignment.handler
    events:
      - http:
          path: /authorization/assignments/{assignmentId}/revoke
          method: post
          cors: true

  listAssignments:
    handler: src/handlers/authorization/listAssignments.handler
    events:
      - http:
          path: /authorization/assignments
          method: get
          cors: true

  getUserRoles:
    handler: src/handlers/authorization/getUserRoles.handler
    events:
      - http:
          path: /authorization/users/{userId}/roles
          method: get
          cors: true

  # Role Management APIs
  createRole:
    handler: src/handlers/roles/create.handler
    events:
      - http:
          path: /roles
          method: post
          cors: true

  getRole:
    handler: src/handlers/roles/get.handler
    events:
      - http:
          path: /roles/{roleId}
          method: get
          cors: true

  getRoleByKey:
    handler: src/handlers/roles/getByKey.handler
    events:
      - http:
          path: /roles/key/{roleKey}
          method: get
          cors: true

  updateRole:
    handler: src/handlers/roles/update.handler
    events:
      - http:
          path: /roles/{roleId}
          method: put
          cors: true

  deleteRole:
    handler: src/handlers/roles/delete.handler
    events:
      - http:
          path: /roles/{roleId}
          method: delete
          cors: true

  listRoles:
    handler: src/handlers/roles/list.handler
    events:
      - http:
          path: /roles
          method: get
          cors: true

  # Policy Management APIs
  createPolicy:
    handler: src/handlers/policies/create.handler
    events:
      - http:
          path: /policies
          method: post
          cors: true

  getPolicy:
    handler: src/handlers/policies/get.handler
    events:
      - http:
          path: /policies/{policyId}
          method: get
          cors: true

  getPolicyByKey:
    handler: src/handlers/policies/getByKey.handler
    events:
      - http:
          path: /policies/key/{policyKey}
          method: get
          cors: true

  updatePolicy:
    handler: src/handlers/policies/update.handler
    events:
      - http:
          path: /policies/{policyId}
          method: put
          cors: true

  deletePolicy:
    handler: src/handlers/policies/delete.handler
    events:
      - http:
          path: /policies/{policyId}
          method: delete
          cors: true

  listPolicies:
    handler: src/handlers/policies/list.handler
    events:
      - http:
          path: /policies
          method: get
          cors: true

  # Asset APIs
  createAsset:
    handler: src/handlers/assets/create.handler
    events:
      - http:
          path: /assets
          method: post
          cors: true

  getAsset:
    handler: src/handlers/assets/get.handler
    events:
      - http:
          path: /assets/{id}
          method: get
          cors: true

  updateAsset:
    handler: src/handlers/assets/update.handler
    events:
      - http:
          path: /assets/{id}
          method: put
          cors: true

  deleteAsset:
    handler: src/handlers/assets/delete.handler
    events:
      - http:
          path: /assets/{id}
          method: delete
          cors: true

  listAssets:
    handler: src/handlers/assets/list.handler
    events:
      - http:
          path: /assets
          method: get
          cors: true

  listAssetsByCustomer:
    handler: src/handlers/assets/listByCustomer.handler
    events:
      - http:
          path: /customers/{customerId}/assets
          method: get
          cors: true

  getAssetChildren:
    handler: src/handlers/assets/getChildren.handler
    events:
      - http:
          path: /assets/{id}/children
          method: get
          cors: true

  getAssetDescendants:
    handler: src/handlers/assets/getDescendants.handler
    events:
      - http:
          path: /assets/{id}/descendants
          method: get
          cors: true

  getAssetTree:
    handler: src/handlers/assets/getTree.handler
    events:
      - http:
          path: /assets/tree
          method: get
          cors: true

  getAssetTreeById:
    handler: src/handlers/assets/getTree.handler
    events:
      - http:
          path: /assets/{id}/tree
          method: get
          cors: true

  moveAsset:
    handler: src/handlers/assets/move.handler
    events:
      - http:
          path: /assets/{id}/move
          method: post
          cors: true

  # Device APIs
  createDevice:
    handler: src/handlers/devices/create.handler
    events:
      - http:
          path: /devices
          method: post
          cors: true

  getDevice:
    handler: src/handlers/devices/get.handler
    events:
      - http:
          path: /devices/{id}
          method: get
          cors: true

  updateDevice:
    handler: src/handlers/devices/update.handler
    events:
      - http:
          path: /devices/{id}
          method: put
          cors: true

  deleteDevice:
    handler: src/handlers/devices/delete.handler
    events:
      - http:
          path: /devices/{id}
          method: delete
          cors: true

  listDevices:
    handler: src/handlers/devices/list.handler
    events:
      - http:
          path: /devices
          method: get
          cors: true

  listDevicesByAsset:
    handler: src/handlers/devices/listByAsset.handler
    events:
      - http:
          path: /assets/{assetId}/devices
          method: get
          cors: true

  moveDevice:
    handler: src/handlers/devices/move.handler
    events:
      - http:
          path: /devices/{id}/move
          method: post
          cors: true

  updateDeviceConnectivity:
    handler: src/handlers/devices/updateConnectivity.handler
    events:
      - http:
          path: /devices/{id}/connectivity
          method: patch
          cors: true

  # Rule APIs
  createRule:
    handler: src/handlers/rules/create.handler
    events:
      - http:
          path: /rules
          method: post
          cors: true

  getRule:
    handler: src/handlers/rules/get.handler
    events:
      - http:
          path: /rules/{id}
          method: get
          cors: true

  updateRule:
    handler: src/handlers/rules/update.handler
    events:
      - http:
          path: /rules/{id}
          method: put
          cors: true

  deleteRule:
    handler: src/handlers/rules/delete.handler
    events:
      - http:
          path: /rules/{id}
          method: delete
          cors: true

  listRulesAll:
    handler: src/handlers/rules/list.handler
    events:
      - http:
          path: /rules
          method: get
          cors: true

  listRulesByCustomer:
    handler: src/handlers/rules/listByCustomer.handler
    events:
      - http:
          path: /customers/{customerId}/rules
          method: get
          cors: true

  toggleRule:
    handler: src/handlers/rules/toggle.handler
    events:
      - http:
          path: /rules/{id}/toggle
          method: post
          cors: true

  evaluateRule:
    handler: src/handlers/rules/evaluate.handler
    events:
      - http:
          path: /rules/evaluate
          method: post
          cors: true

  getMaintenanceWindows:
    handler: src/handlers/rules/getMaintenanceWindows.handler
    events:
      - http:
          path: /rules/maintenance-windows
          method: get
          cors: true

  getRuleStatistics:
    handler: src/handlers/rules/getStatistics.handler
    events:
      - http:
          path: /rules/statistics
          method: get
          cors: true

  # Integration Marketplace APIs
  createPackage:
    handler: src/handlers/integrations/create.handler
    events:
      - http:
          path: /integrations/packages
          method: post
          cors: true

  getPackage:
    handler: src/handlers/integrations/get.handler
    events:
      - http:
          path: /integrations/packages/{id}
          method: get
          cors: true

  getPackageBySlug:
    handler: src/handlers/integrations/getBySlug.handler
    events:
      - http:
          path: /integrations/packages/slug/{slug}
          method: get
          cors: true

  updatePackage:
    handler: src/handlers/integrations/update.handler
    events:
      - http:
          path: /integrations/packages/{id}
          method: put
          cors: true

  deletePackage:
    handler: src/handlers/integrations/delete.handler
    events:
      - http:
          path: /integrations/packages/{id}
          method: delete
          cors: true

  searchPackages:
    handler: src/handlers/integrations/search.handler
    events:
      - http:
          path: /integrations/packages
          method: get
          cors: true

  publishPackageVersion:
    handler: src/handlers/integrations/publish.handler
    events:
      - http:
          path: /integrations/packages/{id}/publish
          method: post
          cors: true

  submitPackageForReview:
    handler: src/handlers/integrations/submitForReview.handler
    events:
      - http:
          path: /integrations/packages/{id}/submit
          method: post
          cors: true

  reviewPackage:
    handler: src/handlers/integrations/review.handler
    events:
      - http:
          path: /integrations/packages/{id}/review
          method: post
          cors: true

  subscribeToPackage:
    handler: src/handlers/integrations/subscribe.handler
    events:
      - http:
          path: /integrations/subscriptions
          method: post
          cors: true

  unsubscribeFromPackage:
    handler: src/handlers/integrations/unsubscribe.handler
    events:
      - http:
          path: /integrations/subscriptions/{subscriptionId}
          method: delete
          cors: true

  listMySubscriptions:
    handler: src/handlers/integrations/listSubscriptions.handler
    events:
      - http:
          path: /integrations/subscriptions
          method: get
          cors: true

  listMyPublishedPackages:
    handler: src/handlers/integrations/listPublisherPackages.handler
    events:
      - http:
          path: /integrations/publisher/packages
          method: get
          cors: true

  # Central APIs
  createCentral:
    handler: src/handlers/centrals/create.handler
    events:
      - http:
          path: /centrals
          method: post
          cors: true

  getCentral:
    handler: src/handlers/centrals/get.handler
    events:
      - http:
          path: /centrals/{id}
          method: get
          cors: true

  getCentralBySerial:
    handler: src/handlers/centrals/getBySerial.handler
    events:
      - http:
          path: /centrals/serial/{serialNumber}
          method: get
          cors: true

  updateCentral:
    handler: src/handlers/centrals/update.handler
    events:
      - http:
          path: /centrals/{id}
          method: put
          cors: true

  deleteCentral:
    handler: src/handlers/centrals/delete.handler
    events:
      - http:
          path: /centrals/{id}
          method: delete
          cors: true

  listCentrals:
    handler: src/handlers/centrals/list.handler
    events:
      - http:
          path: /centrals
          method: get
          cors: true

  listCentralsByAsset:
    handler: src/handlers/centrals/listByAsset.handler
    events:
      - http:
          path: /assets/{assetId}/centrals
          method: get
          cors: true

  updateCentralStatus:
    handler: src/handlers/centrals/updateStatus.handler
    events:
      - http:
          path: /centrals/{id}/status
          method: patch
          cors: true

  updateCentralConnection:
    handler: src/handlers/centrals/updateConnection.handler
    events:
      - http:
          path: /centrals/{id}/connection
          method: patch
          cors: true

  centralHeartbeat:
    handler: src/handlers/centrals/heartbeat.handler
    events:
      - http:
          path: /centrals/{id}/heartbeat
          method: post
          cors: true

  # Theme (Look and Feel) APIs
  createTheme:
    handler: src/handlers/themes/create.handler
    events:
      - http:
          path: /themes
          method: post
          cors: true

  getTheme:
    handler: src/handlers/themes/get.handler
    events:
      - http:
          path: /themes/{id}
          method: get
          cors: true

  updateTheme:
    handler: src/handlers/themes/update.handler
    events:
      - http:
          path: /themes/{id}
          method: put
          cors: true

  quickUpdateTheme:
    handler: src/handlers/themes/quickUpdate.handler
    events:
      - http:
          path: /themes/{id}/quick
          method: patch
          cors: true

  deleteTheme:
    handler: src/handlers/themes/delete.handler
    events:
      - http:
          path: /themes/{id}
          method: delete
          cors: true

  listThemes:
    handler: src/handlers/themes/list.handler
    events:
      - http:
          path: /themes
          method: get
          cors: true

  listThemesByCustomer:
    handler: src/handlers/themes/listByCustomer.handler
    events:
      - http:
          path: /customers/{customerId}/themes
          method: get
          cors: true

  getCustomerDefaultTheme:
    handler: src/handlers/themes/getDefault.handler
    events:
      - http:
          path: /customers/{customerId}/themes/default
          method: get
          cors: true

  setCustomerDefaultTheme:
    handler: src/handlers/themes/setDefault.handler
    events:
      - http:
          path: /customers/{customerId}/themes/{id}/default
          method: post
          cors: true

  compileTheme:
    handler: src/handlers/themes/compile.handler
    events:
      - http:
          path: /themes/{id}/compile
          method: get
          cors: true

  getEffectiveTheme:
    handler: src/handlers/themes/getEffective.handler
    events:
      - http:
          path: /customers/{customerId}/themes/effective
          method: get
          cors: true

  # User APIs
  createUser:
    handler: src/handlers/users/create.handler
    events:
      - http:
          path: /users
          method: post
          cors: true

  getUser:
    handler: src/handlers/users/get.handler
    events:
      - http:
          path: /users/{id}
          method: get
          cors: true

  updateUser:
    handler: src/handlers/users/update.handler
    events:
      - http:
          path: /users/{id}
          method: put
          cors: true

  deleteUser:
    handler: src/handlers/users/delete.handler
    events:
      - http:
          path: /users/{id}
          method: delete
          cors: true

  listUsers:
    handler: src/handlers/users/list.handler
    events:
      - http:
          path: /users
          method: get
          cors: true

  listUsersByCustomer:
    handler: src/handlers/users/listByCustomer.handler
    events:
      - http:
          path: /customers/{customerId}/users
          method: get
          cors: true

  updateUserStatus:
    handler: src/handlers/users/updateStatus.handler
    events:
      - http:
          path: /users/{id}/status
          method: patch
          cors: true

  inviteUser:
    handler: src/handlers/users/invite.handler
    events:
      - http:
          path: /users/invite
          method: post
          cors: true

  acceptInvitation:
    handler: src/handlers/users/acceptInvitation.handler
    events:
      - http:
          path: /users/accept-invitation
          method: post
          cors: true

  verifyUserEmail:
    handler: src/handlers/users/verifyEmail.handler
    events:
      - http:
          path: /users/verify-email
          method: post
          cors: true

  changeUserPassword:
    handler: src/handlers/users/changePassword.handler
    events:
      - http:
          path: /users/{id}/password
          method: put
          cors: true

  requestPasswordReset:
    handler: src/handlers/users/requestPasswordReset.handler
    events:
      - http:
          path: /users/password-reset/request
          method: post
          cors: true

  resetUserPassword:
    handler: src/handlers/users/resetPassword.handler
    events:
      - http:
          path: /users/password-reset/confirm
          method: post
          cors: true

  setupUserMfa:
    handler: src/handlers/users/setupMfa.handler
    events:
      - http:
          path: /users/{id}/mfa/setup
          method: post
          cors: true

  enableUserMfa:
    handler: src/handlers/users/enableMfa.handler
    events:
      - http:
          path: /users/{id}/mfa/enable
          method: post
          cors: true

  disableUserMfa:
    handler: src/handlers/users/disableMfa.handler
    events:
      - http:
          path: /users/{id}/mfa/disable
          method: post
          cors: true

  unlockUser:
    handler: src/handlers/users/unlock.handler
    events:
      - http:
          path: /users/{id}/unlock
          method: post
          cors: true

  getCurrentUser:
    handler: src/handlers/users/me.handler
    events:
      - http:
          path: /users/me
          method: get
          cors: true

  updateUserPreferences:
    handler: src/handlers/users/updatePreferences.handler
    events:
      - http:
          path: /users/{id}/preferences
          method: put
          cors: true

resources:
  Resources:
    # DynamoDB Tables
    CustomersTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.customersTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: parentCustomerId
            AttributeType: S
          - AttributeName: path
            AttributeType: S
          - AttributeName: code
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-parent
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: parentCustomerId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-path
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: path
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-code
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: code
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    PartnersTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.partnersTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-status
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: status
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    RolesTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.rolesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: key
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-key
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: key
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    PoliciesTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.policiesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: key
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-key
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: key
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    RoleAssignmentsTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.roleAssignmentsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
          - AttributeName: roleKey
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-user
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: userId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-role
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: roleKey
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    AssetsTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.assetsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: customerId
            AttributeType: S
          - AttributeName: parentAssetId
            AttributeType: S
          - AttributeName: path
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-customer
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: customerId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-parent
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: parentAssetId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-path
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: path
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    DevicesTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.devicesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: assetId
            AttributeType: S
          - AttributeName: serialNumber
            AttributeType: S
          - AttributeName: status
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-asset
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: assetId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-serial
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: serialNumber
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
          - IndexName: gsi-status
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: status
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    RulesTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.rulesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: customerId
            AttributeType: S
          - AttributeName: type
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-customer
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: customerId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-type
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: type
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    IntegrationsTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.integrationsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: slug
            AttributeType: S
          - AttributeName: publisherId
            AttributeType: S
          - AttributeName: status
            AttributeType: S
          - AttributeName: category
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-slug
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: slug
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-publisher
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: publisherId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-status
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: status
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-category
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: category
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    SubscriptionsTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.subscriptionsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: subscriberId
            AttributeType: S
          - AttributeName: packageId
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-subscriber
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: subscriberId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-package
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: packageId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    CentralsTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.centralsTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: customerId
            AttributeType: S
          - AttributeName: assetId
            AttributeType: S
          - AttributeName: serialNumber
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-customer
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: customerId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-asset
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: assetId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-serial
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: serialNumber
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    ThemesTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.themesTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: customerId
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-customer
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: customerId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    UsersTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:custom.usersTable}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: tenantId
            AttributeType: S
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
          - AttributeName: customerId
            AttributeType: S
          - AttributeName: partnerId
            AttributeType: S
          - AttributeName: username
            AttributeType: S
        KeySchema:
          - AttributeName: tenantId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: gsi-email
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: email
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-customer
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: customerId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-partner
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: partnerId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: gsi-username
            KeySchema:
              - AttributeName: tenantId
                KeyType: HASH
              - AttributeName: username
                KeyType: RANGE
            Projection:
              ProjectionType: KEYS_ONLY
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true

    # EventBridge
    GcdrEventBus:
      Type: AWS::Events::EventBus
      Properties:
        Name: ${self:custom.eventBusName}

  Outputs:
    CustomersTableArn:
      Value: !GetAtt CustomersTable.Arn
    PartnersTableArn:
      Value: !GetAtt PartnersTable.Arn
    AssetsTableArn:
      Value: !GetAtt AssetsTable.Arn
    DevicesTableArn:
      Value: !GetAtt DevicesTable.Arn
    RulesTableArn:
      Value: !GetAtt RulesTable.Arn
    IntegrationsTableArn:
      Value: !GetAtt IntegrationsTable.Arn
    SubscriptionsTableArn:
      Value: !GetAtt SubscriptionsTable.Arn
    CentralsTableArn:
      Value: !GetAtt CentralsTable.Arn
    ThemesTableArn:
      Value: !GetAtt ThemesTable.Arn
    UsersTableArn:
      Value: !GetAtt UsersTable.Arn
    EventBusArn:
      Value: !GetAtt GcdrEventBus.Arn
    ApiEndpoint:
      Value: !Sub 'https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}'
